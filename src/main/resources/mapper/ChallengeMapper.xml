<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fingertips.backend.challenge.mapper.ChallengeMapper">
    <select id="getChallengeList" resultType="ChallengeDTO" parameterType="Integer">
        SELECT
            ch.challenge_idx,ca.category_name,ch.member_idx,ch.challenge_name,ch.challenge_type,ch.challenge_limit,ch.detailed_category,ch.challenge_start_date,ch.challenge_end_date
        FROM
            challenge ch
        JOIN
            category ca ON ca.category_idx = ch.category_idx
        WHERE
            ch.member_idx = #{memberIdx} AND ch.is_public = 1 AND ch.is_delete = 0;
    </select>



    <insert id="insertChallenge"  parameterType="ChallengeDTO">
        INSERT INTO challenge (category, member_id, challenge_name, challenge_type, challenge_limit, detailed_category, start_date, end_date, is_open)
        VALUES (#{category}, #{memberId}, #{challengeName}, #{challengeType}, #{challengeLimit}, #{detailedCategory}, #{startDate}, #{endDate}, #{isOpen})
    </insert>

    <delete id="deleteChallenge" parameterType="Integer">
        UPDATE challenge
        SET is_active = 1
        WHERE id = #{challengeId}
    </delete>

    <select id="getCardHistoryContentByCategory" parameterType="CardHistoryFilterDTO" resultType="CardHistoryDTO">
        SELECT ch.content
        FROM card_history ch
            JOIN card c ON ch.card_id = c.id
        WHERE c.member_id = #{memberId} AND ch.category = #{category} AND c.conn_status = 1
    </select>

    <select id="getChallengeStatus" resultType="ProgressDTO">
        SELECT c.id, c.challenge_limit, COALESCE(COUNT(ch.id), 0) AS cardHistoryCount
--         SELECT c.id, c.challenge_limit,  CASE
--                                              WHEN c.challenge_type = 0 THEN COALESCE(count(ch.id), 0)
--                                              WHEN c.challenge_type = 1 THEN COALESCE(sum(ch.amount), 0)
--             END AS cardHistoryCount
        FROM challenge c
            LEFT JOIN card_history ch
                ON ch.consumption_date BETWEEN c.start_date AND c.end_date
                    AND ch.content LIKE CONCAT('%', c.detailed_category, '%')
                    AND ch.category = c.category
        WHERE member_id = #{memberId} AND is_active = 1
        GROUP BY c.id;
    </select>

    <select id="getAllChallengeList" resultType="ChallengeDTO">
        SELECT *
        FROM challenge
        WHERE
    </select>
</mapper>
