<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fingertips.backend.challenge.mapper.ChallengeMapper">
    <select id="getChallengeList" resultType="ChallengeDTO" parameterType="Integer">
        SELECT id, category, member_id, challenge_name, challenge_type, challenge_limit, detailed_category, start_date, end_date
        FROM challenge
        WHERE member_id = #{memberId}
    </select>

    <insert id="insertChallenge"  parameterType="ChallengeDTO">
        INSERT INTO challenge (category, member_id, challenge_name, challenge_type, challenge_limit, detailed_category, start_date, end_date)
        VALUES (#{category}, #{memberId}, #{challengeName}, #{challengeType}, #{challengeLimit}, #{detailedCategory}, #{startDate}, #{endDate})
    </insert>

    <delete id="deleteChallenge" parameterType="Integer">
        DELETE FROM challenge
        WHERE id = #{challengeId}
    </delete>

    <select id="getCardHistoryContentByCategory" parameterType="CardHistoryFilterDTO" resultType="CardHistoryDTO">
        SELECT ch.content
        FROM card_history ch
            JOIN card c ON ch.card_id = c.id
        WHERE c.member_id = #{memberId} AND ch.category = #{category}
    </select>

    <select id="getChallengeStatus" resultType="ProgressDTO">
        SELECT c.id, c.challenge_limit, COALESCE(COUNT(ch.id), 0) AS cardHistoryCount
        FROM challenge c
            LEFT JOIN card_history ch
                ON ch.consumption_date BETWEEN c.start_date AND c.end_date
                    AND ch.content LIKE CONCAT('%', c.detailed_category, '%')
                    AND ch.category = c.category
        WHERE member_id = #{memberId}
        GROUP BY c.id;
    </select>
</mapper>
